<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æœ¬åœ°éŸ³ä¹æ’­æ”¾å™¨ï½œå…¨æŒ‰é’®ä¿®å¤æœ€ç»ˆç‰ˆ</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
  body{
    background:center center / cover no-repeat fixed;
    transition:background 0.8s ease;
    height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;overflow:hidden
  }
  .mask{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1}

  /* é¡¶éƒ¨æŒ‰é’® - æœ€é«˜å±‚çº§ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ */
  .top-btn-group{
    position:fixed;top:24px;left:0;right:0;
    display:flex;justify-content:space-between;align-items:center;
    padding:0 10px;z-index:99999;
  }
  .top-btn{
    background:rgba(255,255,255,0.12);backdrop-filter:blur(12px);
    border:none;color:#fff;border-radius:12px;white-space:nowrap;
    padding:8px 10px;font-size:13px;cursor:pointer;
    transition:all 0.2s;-webkit-tap-highlight-color:transparent;
    z-index:99999;
  }
  .top-btn.icon-btn{
    width:40px;height:40px;padding:0;border-radius:50%;
    display:grid;place-items:center;font-size:18px;
  }
  .top-btn:active{transform:scale(0.95)}

  /* Toast è½»æç¤º */
  .toast{
    position:fixed;bottom:120px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.8);color:#fff;padding:10px 20px;
    border-radius:8px;font-size:14px;z-index:999999;
    opacity:0;transition:opacity 0.3s;pointer-events:none;
  }
  .toast.show{opacity:1;pointer-events:auto}

  /* å¼¹çª— - æœ€é«˜å±‚çº§ */
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(18px);
    z-index:99998;display:none;align-items:center;justify-content:center;
    opacity:0;transition:opacity 0.3s;
  }
  .modal.show{display:flex;opacity:1}
  .modal-box{
    width:92%;max-width:420px;background:#1a1c2e;
    border-radius:20px;padding:26px;max-height:85vh;
    overflow-y:auto;z-index:99999;
  }
  .modal-header{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:20px;
  }
  .close-modal{
    background:none;border:none;color:#fff;font-size:20px;
    cursor:pointer;width:32px;height:32px;
    display:grid;place-items:center;
    border-radius:50%;transition:background 0.2s;
  }
  .close-modal:active{background:rgba(255,255,255,0.1)}

  /* æœç´¢æ¡† */
  .search-box{
    width:100%;padding:10px 14px;margin-bottom:10px;
    background:rgba(255,255,255,0.08);border:none;border-radius:12px;
    color:#fff;font-size:14px;outline:none;
  }
  .search-box::placeholder{color:rgba(255,255,255,0.5)}

  /* æ•™ç¨‹ & FAQ æ ·å¼ */
  .guide-content,.faq-content{line-height:1.6}
  .guide-content h4{color:#4fc3f7;margin:16px 0 8px;font-size:15px}
  .guide-content p,.faq-content p{margin:4px 0;color:rgba(255,255,255,0.85);font-size:14px}
  .guide-content .step{padding:10px 14px;background:rgba(255,255,255,0.05);border-radius:10px;margin:6px 0}
  .faq-content .qa{margin:10px 0;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px}
  .faq-content .q{color:#4fc3f7;font-weight:bold;margin-bottom:4px}
  .faq-content .a{color:rgba(255,255,255,0.85)}

  /* è®¾ç½®æ ·å¼ */
  .about-desc{margin:10px 0 16px;font-size:12px;color:rgba(255,255,255,0.6);text-align:center}
  .setting-item{padding:12px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:12px;cursor:pointer}
  .setting-item:active{transform:scale(0.96)}
  .bg-time-group{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:10px 0}
  .bg-time-btn{padding:6px 10px;background:rgba(255,255,255,0.1);border:none;color:#fff;border-radius:8px}
  .bg-time-btn.active{background:#409eff}
  .close-set{width:100%;margin-top:16px;padding:10px;background:#409eff;border:none;border-radius:10px;color:#fff}

  /* æ­Œå•æ ·å¼ */
  .local-btn{width:100%;padding:10px;background:rgba(255,255,255,0.1);border:none;border-radius:12px;color:#fff;margin-bottom:12px}
  .local-btn:active{transform:scale(0.98)}
  .section{font-size:13px;color:#aaa;margin-bottom:8px}
  .music-list{display:flex;flex-direction:column;gap:6px}
  .music-item{padding:10px;background:rgba(255,255,255,0.05);border-radius:10px;display:flex;justify-content:space-between;align-items:center}
  .music-name{
    white-space:nowrap;overflow:hidden;
    max-width:200px;
  }
  .music-name.scroll{
    animation:scroll 8s linear infinite
  }
  @keyframes scroll{
    0%{transform:translateX(0)}
    50%{transform:translateX(-100%)}
    100%{transform:translateX(0)}
  }
  .btn-group{display:flex;gap:6px}
  .share-btn{background:#409eff;border:none;color:#fff;border-radius:6px;padding:4px 8px;font-size:12px}
  .del-btn{background:#f56c6c;border:none;color:#fff;border-radius:6px;padding:4px 8px;font-size:12px}
  #fileInput{display:none}

  /* æ­Œè¯åŒº */
  .lyric-box{flex:1;width:100%;max-width:500px;padding:60px 20px 130px;text-align:center;overflow-y:auto;scroll-behavior:smooth}
  .lyric-box::-webkit-scrollbar{display:none}
  .lyric{font-size:16px;line-height:2.8;color:rgba(255,255,255,0.4);transition:all 0.3s}
  .lyric.active{color:#fff;font-size:18px}

  /* æ’­æ”¾æ¨¡å¼æŒ‰é’® */
  .mode-btn{
    background:rgba(255,255,255,0.1);border:none;color:#fff;
    width:36px;height:36px;border-radius:50%;font-size:16px;
    display:grid;place-items:center;cursor:pointer
  }
  .mode-btn:active{transform:scale(0.92)}
  
  /* æ’­æ”¾å™¨åº•éƒ¨ - é«˜å±‚çº§ */
  .player{
    position:fixed;bottom:30px;width:90%;max-width:380px;
    background:rgba(255,255,255,0.08);backdrop-filter:blur(20px);
    border-radius:24px;padding:20px 24px;gap:12px;
    display:flex;flex-direction:column;z-index:9999;
  }
  .title{font-size:15px;color:rgba(255,255,255,0.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center}
  
  .progress-wrap{display:flex;align-items:center;gap:10px}
  .progress-bar{
    -webkit-appearance:none;appearance:none;
    flex:1;height:4px;background:rgba(255,255,255,0.15);border-radius:3px;
    outline:none;
  }
  .progress-bar::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;
    width:16px;height:16px;background:#fff;border-radius:50%;cursor:pointer;
  }
  .time{font-size:12px;color:rgba(255,255,255,0.7);min-width:42px;text-align:center}

  .volume-wrap{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:4px}
  .volume-bar{
    -webkit-appearance:none;appearance:none;
    width:90px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;
    outline:none;
  }
  .volume-bar::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;
    width:12px;height:12px;background:#fff;border-radius:50%;cursor:pointer;
  }

  .controls{display:flex;justify-content:center;align-items:center;gap:16px;margin-top:6px}
  .ctrl-btn{
    background:rgba(255,255,255,0.1);border:none;color:#fff;
    width:44px;height:44px;border-radius:50%;
    display:grid;place-items:center;font-size:20px;cursor:pointer;
    transition:all 0.2s;
  }
  .ctrl-btn:active{transform:scale(0.92)}
  .play-btn{
    background:linear-gradient(135deg,#4fc3f7,#2196f3);
    width:56px;height:56px;font-size:26px;
  }

  .share-bar{
    position:fixed;top:80px;left:50%;transform:translateX(-50%);
    background:#409eff;padding:8px 16px;border-radius:12px;
    display:none;align-items:center;gap:10px;z-index:99999;
  }
  .share-bar.show{display:flex}
  .save-share-btn{background:#fff;color:#409eff;border:none;border-radius:6px;padding:4px 10px;font-weight:bold}

  button{outline:none;border:none;-webkit-tap-highlight-color:transparent}
</style>
</head>
<body>
<div class="mask"></div>
<div class="toast" id="toast"></div>

<!-- é¡¶éƒ¨4ä¸ªæ ¸å¿ƒæŒ‰é’® - ç‹¬ç«‹å±‚çº§ï¼Œç¡®ä¿ç‚¹å‡»æœ‰æ•ˆ -->
<div class="top-btn-group">
  <button class="top-btn" id="openMusicBtn">ğŸµ æˆ‘çš„éŸ³ä¹</button>
  <button class="top-btn" id="openGuideBtn">ğŸ“– ä½¿ç”¨æ•™ç¨‹</button>
  <button class="top-btn" id="openFaqBtn">â“ é—®é¢˜è§£é‡Š</button>
  <button class="top-btn icon-btn" id="openSettingBtn">âš™ï¸</button>
</div>

<!-- åˆ†äº«æç¤ºæ¡ -->
<div class="share-bar" id="shareBar">
  <span>æ£€æµ‹åˆ°åˆ†äº«æ­Œæ›²</span>
  <button class="save-share-btn" id="saveShareBtn">ä¿å­˜åˆ°æ­Œå•</button>
</div>

<!-- ä½¿ç”¨æ•™ç¨‹å¼¹çª— -->
<div class="modal" id="guideModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>ğŸ“– ä½¿ç”¨æ•™ç¨‹</h3>
      <button class="close-modal" id="closeGuideBtn">âœ•</button>
    </div>
    <div class="guide-content">
      <h4>ä¸€ã€å¦‚ä½•æ‰¾åˆ°æœ¬åœ°éŸ³ä¹æ–‡ä»¶</h4>
      <div class="step">
        <p>âœ… å®‰å“æ‰‹æœºï¼šæ–‡ä»¶ç®¡ç† â†’ éŸ³ä¹ / ä¸‹è½½ / Audio æ–‡ä»¶å¤¹</p>
        <p>âœ… è‹¹æœæ‰‹æœºï¼šæ–‡ä»¶APP â†’ æµè§ˆ â†’ ä¸‹è½½é¡¹ / éŸ³ä¹</p>
        <p>âœ… ç”µè„‘Windowsï¼šæ­¤ç”µè„‘ â†’ éŸ³ä¹æ–‡ä»¶å¤¹ / ä¸‹è½½æ–‡ä»¶å¤¹</p>
        <p>âœ… ç”µè„‘Macï¼šè®¿è¾¾ â†’ éŸ³ä¹ / ä¸‹è½½</p>
      </div>
      <h4>äºŒã€å„å¤§éŸ³ä¹å¹³å°ä¸‹è½½ç›®å½•</h4>
      <div class="step">
        <p>ğŸ“ ç½‘æ˜“äº‘ï¼šAndroid/data/com.netease.cloudmusic/files/Music</p>
        <p>ğŸ“ QQéŸ³ä¹ï¼šAndroid/data/com.tencent.qqmusic/files/qqmusic/mp3</p>
        <p>ğŸ“ é…·ç‹—ï¼šAndroid/data/com.kugou.android/files/kgmusic/download</p>
        <p>ğŸ“ é…·æˆ‘ï¼šAndroid/data/com.kuwo.android/files/kuwo/music</p>
        <p>ğŸ“ å’ªå’•ï¼šAndroid/data/comcmcc.music/files/migu/download</p>
      </div>
      <h4>ä¸‰ã€å¦‚ä½•åˆæ³•å…è´¹ä¸‹è½½éŸ³ä¹</h4>
      <div class="step">
        <p>âœ… å’ªå’•éŸ³ä¹å¤§é‡æ­£ç‰ˆå…è´¹æ­Œæ›²</p>
        <p>âœ… å„å¹³å°å…è´¹ä¸“åŒºã€åŸåˆ›æ­Œæ›²</p>
        <p>âœ… å…¬ä¼—ç‰ˆæƒã€çº¯éŸ³ä¹å…è´¹æ›²åº“</p>
      </div>
      <h4>å››ã€ä¸Šä¼  & æ’­æ”¾æ“ä½œ</h4>
      <div class="step">
        <p>1. ç‚¹å‡»ã€Œæˆ‘çš„éŸ³ä¹ã€â†’ã€Œä¸Šä¼ MP3æ­Œæ›²ã€</p>
        <p>2. ç‚¹å‡»æ­Œå•é‡Œçš„æ­Œæ›²åå³å¯æ’­æ”¾</p>
        <p>3. æ”¯æŒæœç´¢ã€å¾ªç¯/å•æ›²/éšæœºæ’­æ”¾</p>
      </div>
    </div>
  </div>
</div>

<!-- å¸¸è§é—®é¢˜å¼¹çª— -->
<div class="modal" id="faqModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>â“ å¸¸è§é—®é¢˜</h3>
      <button class="close-modal" id="closeFaqBtn">âœ•</button>
    </div>
    <div class="faq-content">
      <div class="qa"><div class="q">1. å¦‚ä½•ä¸Šä¼ æ­Œæ›²ï¼Ÿ</div><div class="a">ç‚¹å‡»ã€Œæˆ‘çš„éŸ³ä¹ã€â†’ã€Œä¸Šä¼ MP3æ­Œæ›²ã€ï¼Œé€‰æ‹©æœ¬åœ°éŸ³é¢‘æ–‡ä»¶å³å¯ã€‚</div></div>
      <div class="qa"><div class="q">2. æ’­æ”¾æ²¡å£°éŸ³æ€ä¹ˆåŠï¼Ÿ</div><div class="a">æ£€æŸ¥è®¾å¤‡éŸ³é‡ã€æ’­æ”¾å™¨éŸ³é‡æ»‘å—ï¼Œç¡®è®¤æ­Œæ›²æ–‡ä»¶å®Œæ•´æœªæŸåã€‚</div></div>
      <div class="qa"><div class="q">3. è¿›åº¦æ¡æ‹–ä¸åŠ¨ï¼Ÿ</div><div class="a">å…ˆæ’­æ”¾æ­Œæ›²1ç§’ï¼Œç­‰æ–‡ä»¶åŠ è½½å®Œæˆåå³å¯æ‹–åŠ¨è·³è½¬ã€‚</div></div>
      <div class="qa"><div class="q">4. å¦‚ä½•æ›´æ¢èƒŒæ™¯ï¼Ÿ</div><div class="a">è¿›å…¥è®¾ç½®ï¼Œå¯æ‰‹åŠ¨ç«‹å³æ›´æ¢ï¼Œä¹Ÿå¯è®¾ç½®è‡ªåŠ¨åˆ‡æ¢é—´éš”ã€‚</div></div>
      <div class="qa"><div class="q">5. æ­Œæ›²ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨å—ï¼Ÿ</div><div class="a">ä¸ä¼šï¼Œæ‰€æœ‰æ­Œæ›²éƒ½ä¿å­˜åœ¨ä½ çš„æœ¬åœ°è®¾å¤‡ï¼Œçº¯æœ¬åœ°è¿è¡Œã€‚</div></div>
    </div>
  </div>
</div>

<!-- æˆ‘çš„éŸ³ä¹æ­Œå•å¼¹çª— -->
<div class="modal" id="musicModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>æœ¬åœ°éŸ³ä¹åº“</h3>
      <button class="close-modal" id="closeMusicBtn">âœ•</button>
    </div>
    <button class="local-btn" id="uploadBtn">ğŸ“ ä¸Šä¼ MP3æ­Œæ›²</button>
    <input type="file" id="fileInput" accept="audio/*" multiple>
    <input type="text" class="search-box" id="searchInput" placeholder="ğŸ” æœç´¢æ­Œæ›²">
    <div class="section">âœ… å·²ä¿å­˜æ­Œæ›²</div>
    <div class="music-list" id="musicList"></div>
  </div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal" id="settingModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>è®¾ç½®</h3>
      <button class="close-modal" id="closeSettingBtn">âœ•</button>
    </div>
    <div class="about-desc">æœ¬åœ°éŸ³ä¹æ’­æ”¾å™¨<br>çº¯æœ¬åœ°è¿è¡Œ | æ­Œæ›²æ°¸ä¹…ä¿å­˜ | æ— ç½‘ç»œä¾èµ–</div>
    <div class="setting-item" id="changeBgBtn">ğŸ”„ ç«‹å³æ›´æ¢èƒŒæ™¯</div>
    <div style="margin-top:10px;font-size:14px;color:#aaa;">è‡ªåŠ¨æ¢èƒŒæ™¯é—´éš”</div>
    <div class="bg-time-group">
      <button class="bg-time-btn" data-time="0">å…³é—­</button>
      <button class="bg-time-btn" data-time="5">5ç§’</button>
      <button class="bg-time-btn" data-time="10">10ç§’</button>
      <button class="bg-time-btn" data-time="30">30ç§’</button>
      <button class="bg-time-btn" data-time="60">1åˆ†é’Ÿ</button>
    </div>
    <div class="setting-item" id="clearAllBtn">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨æ­Œæ›²</div>
    <button class="close-set" id="closeSetBtn">å…³é—­è®¾ç½®</button>
  </div>
</div>

<!-- æ­Œè¯æ˜¾ç¤ºåŒº -->
<div class="lyric-box" id="lyricBox">
  <div class="lyric active">ç­‰å¾…æ’­æ”¾æœ¬åœ°éŸ³ä¹</div>
</div>

<!-- åº•éƒ¨æ’­æ”¾å™¨ -->
<div class="player">
  <div class="title" id="musicTitle">æœªæ’­æ”¾</div>
  <div class="progress-wrap">
    <span class="time" id="currentTime">0:00</span>
    <input type="range" class="progress-bar" id="progressBar" min="0" max="100" value="0">
    <span class="time" id="totalTime">0:00</span>
  </div>
  <div class="volume-wrap">
    <div class="volume-icon">ğŸ”Š</div>
    <input type="range" class="volume-bar" id="volumeBar" min="0" max="100" value="80">
  </div>
  <div class="controls">
    <button class="mode-btn" id="modeBtn">ğŸ”</button>
    <button class="ctrl-btn" id="prevBtn">â®</button>
    <button class="ctrl-btn play-btn" id="playBtn">â–¶</button>
    <button class="ctrl-btn" id="nextBtn">â­</button>
  </div>
</div>

<script>
// ========== å…¨å±€å˜é‡ ==========
const audio = new Audio()
let currentIndex = Number(localStorage.getItem("lastPlayIndex")) || 0
let currentLrc = []
let localSongs = JSON.parse(localStorage.getItem("localMusicPlayer")) || []
let currentShareSong = null
let bgTimer = null
let bgInterval = Number(localStorage.getItem("bgInterval")) || 0
let playMode = localStorage.getItem("playMode") || "loop" // loopåˆ—è¡¨å¾ªç¯ / singleå•æ›²å¾ªç¯ / randoméšæœº
let isUploading = false

// è¶…å¤§å…¨é«˜æ¸…èƒŒæ™¯åº“
const bgList = [
  "https://picsum.photos/id/1039/1920/1080","https://picsum.photos/id/1047/1920/1080","https://picsum.photos/id/1058/1920/1080","https://picsum.photos/id/1069/1920/1080","https://picsum.photos/id/1080/1920/1080",
  "https://picsum.photos/id/160/1920/1080","https://picsum.photos/id/152/1920/1080","https://picsum.photos/id/15/1920/1080","https://picsum.photos/id/29/1920/1080","https://picsum.photos/id/36/1920/1080",
  "https://picsum.photos/id/56/1920/1080","https://picsum.photos/id/65/1920/1080","https://picsum.photos/id/76/1920/1080","https://picsum.photos/id/87/1920/1080","https://picsum.photos/id/96/1920/1080",
  "https://picsum.photos/id/116/1920/1080","https://picsum.photos/id/127/1920/1080","https://picsum.photos/id/138/1920/1080","https://picsum.photos/id/149/1920/1080","https://picsum.photos/id/175/1920/1080"
]

// å†…ç½®æ­Œè¯åº“
const lrcMap = {
  "æ™´å¤©":"[00:00.00]ä»å‰ä»å‰æœ‰ä¸ªäººçˆ±ä½ å¾ˆä¹…\n[00:03.00]ååé£æ¸æ¸æŠŠè·ç¦»å¹å¾—å¥½è¿œ",
  "ä¸ƒé‡Œé¦™":"[00:00.00]çª—å¤–çš„éº»é›€ åœ¨ç”µçº¿æ†ä¸Šå¤šå˜´",
  "å­¤å‹‡è€…":"[00:00.00]éƒ½æ˜¯å‹‡æ•¢çš„\n[00:02.00]ä½ é¢å¤´çš„ä¼¤å£",
  "å°åŸå¤å¤©":"[00:00.00]æ©˜é»„è‰²çš„æ—¥è½ åæ²¡åœ¨æµ·å¹³çº¿"
}

// ========== æ ¸å¿ƒå·¥å…·å‡½æ•° ==========
// Toastè½»æç¤º
function toast(msg) {
  const toastEl = document.getElementById("toast")
  toastEl.textContent = msg
  toastEl.classList.add("show")
  setTimeout(() => toastEl.classList.remove("show"), 2000)
}

// éšæœºèƒŒæ™¯
function setRandomBg() {
  const randomIndex = Math.floor(Math.random() * bgList.length)
  document.body.style.backgroundImage = `url(${bgList[randomIndex]})`
}

// è‡ªåŠ¨æ¢èƒŒæ™¯å®šæ—¶å™¨
function startBgTimer(seconds) {
  clearInterval(bgTimer)
  if (seconds > 0) {
    bgTimer = setInterval(setRandomBg, seconds * 1000)
  }
}

// æ—¶é—´æ ¼å¼åŒ–
function formatTime(time) {
  const minutes = Math.floor(time / 60)
  const seconds = Math.floor(time % 60)
  return `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`
}

// ä¿å­˜æ­Œå•åˆ°æœ¬åœ°
function saveLibrary() {
  localStorage.setItem("localMusicPlayer", JSON.stringify(localSongs))
}

// æ–‡ä»¶è½¬base64
function fileToBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader()
    reader.onload = () => resolve(reader.result)
    reader.readAsDataURL(file)
  })
}

// æ­Œè¯è§£æ
function parseLrc(text) {
  return text.split("\n").map(line => {
    const match = line.match(/\[(\d+):(\d+\.\d+)\](.*)/)
    return match ? { time: match[1] * 60 + parseFloat(match[2]), text: match[3].trim() } : null
  }).filter(Boolean)
}

// æ¸²æŸ“æ­Œè¯
function renderLrc() {
  const lyricBox = document.getElementById("lyricBox")
  lyricBox.innerHTML = ""
  currentLrc.forEach(item => {
    const div = document.createElement("div")
    div.className = "lyric"
    div.innerText = item.text
    lyricBox.appendChild(div)
  })
}

// æ›´æ–°æ­Œè¯é«˜äº®
function updateLrc() {
  const currentTime = audio.currentTime
  const activeIndex = currentLrc.findLastIndex(item => item.time <= currentTime)
  document.querySelectorAll(".lyric").forEach((el, i) => {
    el.classList.toggle("active", i === activeIndex)
  })
  const activeEl = document.querySelector(".lyric.active")
  if (activeEl) activeEl.scrollIntoView({ behavior: "smooth", block: "center" })
}

// è·å–åŒ¹é…æ­Œè¯
function getLrc(songName) {
  const name = songName.replace(/\.\w+$/, "").trim()
  for (let key in lrcMap) {
    if (name.includes(key) || key.includes(name)) return lrcMap[key]
  }
  return "[00:00.00]æš‚æ— æ­Œè¯"
}

// æ’­æ”¾æ­Œæ›²
function play(index) {
  if (!localSongs.length) {
    toast("æš‚æ— æ­Œæ›²ï¼Œè¯·å…ˆä¸Šä¼ ")
    return
  }
  // åœæ­¢å½“å‰æ’­æ”¾
  audio.pause()
  // ä¿®æ­£ç´¢å¼•
  currentIndex = Math.max(0, Math.min(index, localSongs.length - 1))
  localStorage.setItem("lastPlayIndex", currentIndex)
  // è·å–æ­Œæ›²
  const song = localSongs[currentIndex]
  // è®¾ç½®éŸ³é¢‘
  audio.src = song.base64
  document.getElementById("musicTitle").innerText = song.name
  // å¤„ç†æ­Œè¯
  currentLrc = parseLrc(getLrc(song.name))
  renderLrc()
  // åŠ è½½å¹¶æ’­æ”¾
  audio.load()
  audio.play().catch(() => toast("æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"))
  document.getElementById("playBtn").innerText = "â¸"
  // å…³é—­æ‰€æœ‰å¼¹çª—
  document.querySelectorAll(".modal").forEach(modal => modal.classList.remove("show"))
  document.getElementById("shareBar").classList.remove("show")
}

// æ¸²æŸ“æ­Œå•
function renderList(keyword = "") {
  const musicList = document.getElementById("musicList")
  musicList.innerHTML = ""
  // æœç´¢è¿‡æ»¤
  const filteredSongs = localSongs.filter(song => 
    song.name.toLowerCase().includes(keyword.toLowerCase())
  )
  // ç©ºçŠ¶æ€
  if (!filteredSongs.length) {
    musicList.innerHTML = `<div style="padding:10px;color:#aaa;text-align:center;">æš‚æ— åŒ¹é…æ­Œæ›²</div>`
    return
  }
  // æ¸²æŸ“åˆ—è¡¨
  filteredSongs.forEach((song) => {
    const realIndex = localSongs.findIndex(s => s.name === song.name)
    // æ­Œæ›²é¡¹
    const item = document.createElement("div")
    item.className = "music-item"
    // æ­Œæ›²å
    const nameSpan = document.createElement("span")
    nameSpan.className = song.name.length > 15 ? "music-name scroll" : "music-name"
    nameSpan.innerText = song.name
    nameSpan.onclick = () => play(realIndex)
    // æŒ‰é’®ç»„
    const btnGroup = document.createElement("div")
    btnGroup.className = "btn-group"
    // åˆ†äº«æŒ‰é’®
    const shareBtn = document.createElement("button")
    shareBtn.className = "share-btn"
    shareBtn.innerText = "åˆ†äº«"
    shareBtn.onclick = (e) => {
      e.stopPropagation()
      try {
        const data = JSON.stringify({ name: song.name, base64: song.base64 })
        const shareUrl = location.origin + location.pathname + "#" + encodeURIComponent(data)
        navigator.clipboard.writeText(shareUrl).then(() => toast("åˆ†äº«é“¾æ¥å·²å¤åˆ¶"))
      } catch (e) {
        toast("åˆ†äº«å¤±è´¥")
      }
    }
    // åˆ é™¤æŒ‰é’® - ä¿®å¤äº†å˜é‡åé”™è¯¯
    const delBtn = document.createElement("button")
    delBtn.className = "del-btn"
    delBtn.innerText = "åˆ é™¤"
    delBtn.onclick = (e) => {
      e.stopPropagation()
      if (!confirm("ç¡®å®šåˆ é™¤è¿™é¦–æ­Œï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼")) return
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›²
      if (realIndex === currentIndex) {
        audio.pause()
        audio.src = ""
        document.getElementById("musicTitle").innerText = "æœªæ’­æ”¾"
        document.getElementById("playBtn").innerText = "â–¶"
        document.getElementById("lyricBox").innerHTML = `<div class="lyric active">ç­‰å¾…æ’­æ”¾æœ¬åœ°éŸ³ä¹</div>`
      }
      // åˆ é™¤æ­Œæ›²
      localSongs.splice(realIndex, 1)
      if (currentIndex > 0 && realIndex <= currentIndex) currentIndex--
      saveLibrary()
      renderList(keyword)
      toast("å·²åˆ é™¤æ­Œæ›²")
    }
    // ç»„è£…
    btnGroup.appendChild(shareBtn)
    btnGroup.appendChild(delBtn)
    item.appendChild(nameSpan)
    item.appendChild(btnGroup)
    musicList.appendChild(item)
  })
}

// åˆ‡æ­Œé€»è¾‘
function nextSong() {
  if (!localSongs.length) return
  if (playMode === "random") {
    currentIndex = Math.floor(Math.random() * localSongs.length)
  } else if (playMode === "single") {
    audio.currentTime = 0
    audio.play().catch(() => {})
    return
  } else {
    currentIndex = (currentIndex + 1) % localSongs.length
  }
  play(currentIndex)
}

// æ›´æ–°æ’­æ”¾æ¨¡å¼æŒ‰é’®
function updateModeBtn() {
  const modeBtn = document.getElementById("modeBtn")
  if (playMode === "loop") modeBtn.textContent = "ğŸ”"
  if (playMode === "single") modeBtn.textContent = "ğŸ”‚"
  if (playMode === "random") modeBtn.textContent = "ğŸ”€"
}

// è§£æåˆ†äº«é“¾æ¥
function loadShareData() {
  if (!location.hash) return
  try {
    const data = JSON.parse(decodeURIComponent(location.hash.slice(1)))
    currentShareSong = data
    audio.src = data.base64
    document.getElementById("musicTitle").innerText = "[åˆ†äº«]" + data.name
    audio.play().catch(() => {})
    document.getElementById("playBtn").innerText = "â¸"
    document.getElementById("shareBar").classList.add("show")
    history.replaceState(null, null, " ")
  } catch (e) {}
}

// ========== DOMåŠ è½½å®Œæˆåï¼Œç»‘å®šæ‰€æœ‰æŒ‰é’®äº‹ä»¶ ==========
document.addEventListener("DOMContentLoaded", () => {
  // ========== 1. é¡¶éƒ¨æ ¸å¿ƒæŒ‰é’® - 100%ç”Ÿæ•ˆ ==========
  // æˆ‘çš„éŸ³ä¹ - ä¿®å¤äº†æ¸²æŸ“åˆ—è¡¨å‰çš„é€»è¾‘é—®é¢˜
  const openMusicBtn = document.getElementById("openMusicBtn")
  const closeMusicBtn = document.getElementById("closeMusicBtn")
  const musicModal = document.getElementById("musicModal")
  openMusicBtn.onclick = () => {
    renderList("") // ç¡®ä¿å…ˆæ¸²æŸ“ç©ºæœç´¢ç»“æœï¼Œé¿å…é”™è¯¯
    musicModal.classList.add("show")
    toast("æˆ‘çš„éŸ³ä¹å·²æ‰“å¼€") // æ·»åŠ è°ƒè¯•æç¤ºï¼Œç¡®è®¤æŒ‰é’®æ­£å¸¸è§¦å‘
  }
  closeMusicBtn.onclick = () => musicModal.classList.remove("show")
  musicModal.onclick = (e) => {
    if (e.target === musicModal) musicModal.classList.remove("show")
  }

  // ä½¿ç”¨æ•™ç¨‹
  const openGuideBtn = document.getElementById("openGuideBtn")
  const closeGuideBtn = document.getElementById("closeGuideBtn")
  const guideModal = document.getElementById("guideModal")
  openGuideBtn.onclick = () => guideModal.classList.add("show")
  closeGuideBtn.onclick = () => guideModal.classList.remove("show")
  guideModal.onclick = (e) => {
    if (e.target === guideModal) guideModal.classList.remove("show")
  }

  // é—®é¢˜è§£é‡Š
  const openFaqBtn = document.getElementById("openFaqBtn")
  const closeFaqBtn = document.getElementById("closeFaqBtn")
  const faqModal = document.getElementById("faqModal")
  openFaqBtn.onclick = () => faqModal.classList.add("show")
  closeFaqBtn.onclick = () => faqModal.classList.remove("show")
  faqModal.onclick = (e) => {
    if (e.target === faqModal) faqModal.classList.remove("show")
  }

  // è®¾ç½®
  const openSettingBtn = document.getElementById("openSettingBtn")
  const closeSettingBtn = document.getElementById("closeSettingBtn")
  const settingModal = document.getElementById("settingModal")
  const closeSetBtn = document.getElementById("closeSetBtn")
  openSettingBtn.onclick = () => settingModal.classList.add("show")
  closeSettingBtn.onclick = () => settingModal.classList.remove("show")
  closeSetBtn.onclick = () => settingModal.classList.remove("show")
  settingModal.onclick = (e) => {
    if (e.target === settingModal) settingModal.classList.remove("show")
  }

  // ========== 2. æ­Œå•å†…æŒ‰é’® ==========
  // ä¸Šä¼ æ­Œæ›²
  const uploadBtn = document.getElementById("uploadBtn")
  const fileInput = document.getElementById("fileInput")
  uploadBtn.onclick = () => {
    if (isUploading) {
      toast("æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™")
      return
    }
    fileInput.click()
  }
  fileInput.onchange = async (e) => {
    isUploading = true
    toast("æ­£åœ¨ä¸Šä¼ æ­Œæ›²...")
    const files = Array.from(e.target.files)
    let successCount = 0
    for (const file of files) {
      if (!file.type.includes("audio") || localSongs.some(s => s.name === file.name)) continue
      try {
        const base64 = await fileToBase64(file)
        localSongs.push({ name: file.name, base64: base64 })
        successCount++
      } catch (e) {
        continue
      }
    }
    saveLibrary()
    renderList(document.getElementById("searchInput").value.trim())
    isUploading = false
    toast(successCount > 0 ? `æˆåŠŸä¸Šä¼ ${successCount}é¦–æ­Œæ›²` : "ä¸Šä¼ å¤±è´¥ï¼Œæ–‡ä»¶å·²å­˜åœ¨æˆ–æ ¼å¼ä¸æ”¯æŒ")
  }

  // æœç´¢æ­Œæ›²
  const searchInput = document.getElementById("searchInput")
  searchInput.oninput = () => renderList(searchInput.value.trim())

  // ========== 3. è®¾ç½®å†…æŒ‰é’® ==========
  // ç«‹å³æ¢èƒŒæ™¯
  const changeBgBtn = document.getElementById("changeBgBtn")
  changeBgBtn.onclick = () => {
    setRandomBg()
    settingModal.classList.remove("show")
    toast("å·²æ›´æ¢èƒŒæ™¯")
  }

  // è‡ªåŠ¨æ¢èƒŒæ™¯æ—¶é—´
  const bgTimeBtns = document.querySelectorAll(".bg-time-btn")
  bgTimeBtns.forEach(btn => {
    btn.onclick = () => {
      bgTimeBtns.forEach(b => b.classList.remove("active"))
      btn.classList.add("active")
      bgInterval = Number(btn.dataset.time)
      localStorage.setItem("bgInterval", bgInterval)
      startBgTimer(bgInterval)
      toast(`å·²è®¾ç½®ï¼š${bgInterval === 0 ? 'å…³é—­è‡ªåŠ¨æ¢èƒŒæ™¯' : bgInterval + 'ç§’'}`)
    }
  })

  // æ¸…ç©ºå…¨éƒ¨æ­Œæ›²
  const clearAllBtn = document.getElementById("clearAllBtn")
  clearAllBtn.onclick = () => {
    if (!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ­Œæ›²ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return
    localSongs = []
    saveLibrary()
    renderList()
    audio.pause()
    audio.src = ""
    document.getElementById("musicTitle").innerText = "æœªæ’­æ”¾"
    document.getElementById("playBtn").innerText = "â–¶"
    document.getElementById("lyricBox").innerHTML = `<div class="lyric active">ç­‰å¾…æ’­æ”¾æœ¬åœ°éŸ³ä¹</div>`
    settingModal.classList.remove("show")
    toast("å·²æ¸…ç©ºå…¨éƒ¨æ­Œæ›²")
  }

  // ========== 4. æ’­æ”¾å™¨æ§åˆ¶æŒ‰é’® ==========
  // æ’­æ”¾/æš‚åœ
  const playBtn = document.getElementById("playBtn")
  playBtn.onclick = async () => {
    if (!audio.src) {
      if (localSongs.length) {
        play(currentIndex)
      } else {
        toast("æš‚æ— æ­Œæ›²ï¼Œè¯·å…ˆä¸Šä¼ ")
      }
      return
    }
    if (audio.paused) {
      await audio.play()
      playBtn.innerText = "â¸"
    } else {
      audio.pause()
      playBtn.innerText = "â–¶"
    }
  }

  // ä¸Šä¸€æ›²
  const prevBtn = document.getElementById("prevBtn")
  prevBtn.onclick = () => {
    if (!localSongs.length) {
      toast("æš‚æ— æ­Œæ›²")
      return
    }
    currentIndex = (currentIndex - 1 + localSongs.length) % localSongs.length
    play(currentIndex)
  }

  // ä¸‹ä¸€æ›²
  const nextBtn = document.getElementById("nextBtn")
  nextBtn.onclick = () => nextSong()

  // æ’­æ”¾æ¨¡å¼åˆ‡æ¢
  const modeBtn = document.getElementById("modeBtn")
  modeBtn.onclick = () => {
    if (playMode === "loop") playMode = "single"
    else if (playMode === "single") playMode = "random"
    else playMode = "loop"
    localStorage.setItem("playMode", playMode)
    updateModeBtn()
    if (playMode === "loop") toast("åˆ—è¡¨å¾ªç¯")
    if (playMode === "single") toast("å•æ›²å¾ªç¯")
    if (playMode === "random") toast("éšæœºæ’­æ”¾")
  }

  // ========== 5. è¿›åº¦æ¡ & éŸ³é‡æ¡ ==========
  const progressBar = document.getElementById("progressBar")
  const currentTimeEl = document.getElementById("currentTime")
  const totalTimeEl = document.getElementById("totalTime")
  const volumeBar = document.getElementById("volumeBar")

  // è¿›åº¦æ¡æ‹–åŠ¨
  progressBar.addEventListener("input", () => {
    if (!audio.duration) return
    audio.currentTime = audio.duration * (progressBar.value / 100)
    currentTimeEl.innerText = formatTime(audio.currentTime)
  })

  // éŸ³é‡è°ƒèŠ‚
  volumeBar.addEventListener("input", () => {
    audio.volume = volumeBar.value / 100
    localStorage.setItem("volume", volumeBar.value)
  })

  // éŸ³é¢‘äº‹ä»¶åŒæ­¥
  audio.ontimeupdate = () => {
    if (!audio.duration) return
    const percent = (audio.currentTime / audio.duration) * 100
    progressBar.value = percent
    currentTimeEl.innerText = formatTime(audio.currentTime)
    updateLrc()
  }
  audio.onloadedmetadata = () => {
    totalTimeEl.innerText = formatTime(audio.duration)
  }
  audio.onended = () => nextSong()

  // ========== 6. åˆ†äº«ä¿å­˜æŒ‰é’® ==========
  const saveShareBtn = document.getElementById("saveShareBtn")
  saveShareBtn.onclick = () => {
    if (!currentShareSong) return
    if (localSongs.some(s => s.name === currentShareSong.name)) {
      toast("æ­Œå•ä¸­å·²å­˜åœ¨è¯¥æ­Œæ›²")
      return
    }
    localSongs.push(currentShareSong)
    saveLibrary()
    renderList()
    document.getElementById("shareBar").classList.remove("show")
    toast("ä¿å­˜æˆåŠŸï¼")
  }

  // ========== åˆå§‹åŒ– ==========
  setRandomBg()
  // åŠ è½½èƒŒæ™¯è®¾ç½®
  bgTimeBtns.forEach(btn => {
    if (Number(btn.dataset.time) === bgInterval) btn.classList.add("active")
  })
  startBgTimer(bgInterval)
  // åŠ è½½éŸ³é‡è®¾ç½®
  const savedVolume = Number(localStorage.getItem("volume")) || 80
  volumeBar.value = savedVolume
  audio.volume = savedVolume / 100
  // æ›´æ–°æ’­æ”¾æ¨¡å¼
  updateModeBtn()
  // åŠ è½½åˆ†äº«æ•°æ®
  loadShareData()
  // è‡ªåŠ¨æ’­æ”¾ä¸Šæ¬¡æ­Œæ›²
  if (localSongs.length && currentIndex < localSongs.length) {
    const lastSong = localSongs[currentIndex]
    audio.src = lastSong.base64
    document.getElementById("musicTitle").innerText = lastSong.name
    currentLrc = parseLrc(getLrc(lastSong.name))
    renderLrc()
  }
})
</script>

<!-- é˜²å°ç™½åŠ å¯†ï¼šç¦æ­¢å³é”® + ç¦æ­¢F12 + ç¦æ­¢æŸ¥çœ‹æºç  -->
<script>
// ç¦æ­¢å³é”®èœå•
document.oncontextmenu = function () {
    return false;
};
// ç¦æ­¢F12ã€Ctrl+Shift+Iã€Ctrl+U
document.onkeydown = function (e) {
    if (e.key === "F12" || 
        (e.ctrlKey && e.shiftKey && e.key === "I") || 
        (e.ctrlKey && e.key === "U")) {
        return false;
    }
};
</script>
</body>
</html>
